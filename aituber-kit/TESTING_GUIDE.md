# テストガイド - 新機能のデバッグログ確認方法

このドキュメントでは、実装した新機能（長期記憶システム、Self-Reflectionプロンプト、サーチグラウンディング検出、掛け合いターン数）をテストするためのデバッグログの確認方法を説明します。

## テスト環境の準備

1. 開発サーバーを起動
   ```bash
   npm run dev
   # または
   start_dev.bat
   ```

2. ブラウザの開発者ツールを開く
   - Chrome/Edge: `F12` または `Ctrl+Shift+I`
   - コンソールタブを選択

3. ログをフィルタリング
   - コンソールの検索ボックスに `[handlers]` または `[memoryManager]` などを入力してフィルタリング

## テスト項目と確認方法

### 1. 長期記憶システムのテスト

#### テスト手順
1. ユーザー名を入力して記憶を保存
   - 例: 「私の名前は太郎です」
2. 関連する話題で会話を続ける
   - 例: 「太郎について教えて」

#### 確認すべきログ
- `[memoryExtractor] 📝 会話から記憶を抽出:` - 記憶が抽出されたか
- `[memoryManager] ✅ 記憶を保存しました:` - 記憶が保存されたか
- `[handlers] 🔍 関連記憶を検索開始:` - 関連記憶の検索が開始されたか
- `[memoryManager] 🔍 関連記憶を検索:` - 関連記憶が見つかったか
- `[handlers] ✅ 関連記憶をシステムプロンプトに注入:` - システムプロンプトに記憶が注入されたか

#### 期待される動作
- ユーザー名が抽出され、保存される
- 関連する話題で会話する際、保存された記憶が検索される
- 検索された記憶がシステムプロンプトに注入される

### 2. Self-Reflectionプロンプトのテスト

#### テスト手順
1. 任意のメッセージを送信

#### 確認すべきログ
- `[handlers] ✅ Self-Reflectionプロンプトをシステムプロンプトに組み込み:` - Self-Reflectionプロンプトが組み込まれたか

#### 期待される動作
- システムプロンプトにSelf-Reflectionプロンプトが自動的に組み込まれる
- AIの回答品質が向上する

### 3. サーチグラウンディング検出のテスト

#### テスト手順
1. サーチグラウンディングが必要な話題で会話
   - 例: 「最新のVtuber情報を教えてサーチ」
2. サーチグラウンディングが不要な話題で会話
   - 例: 「今日はいい天気だね」

#### 確認すべきログ
- `[vercel.ts] 🔍 サーチグラウンディング検出詳細:` - 検出の詳細情報
- `[vercel.ts] ✅ サーチグラウンディング検出成功:` - サーチグラウンディングが検出された場合
- `[vercel.ts] ❌ サーチグラウンディング未検出:` - サーチグラウンディングが検出されなかった場合
- `[handlers] ✅ サーチグラウンディング検出（メタデータから）:` - メタデータから検出された場合
- `[handlers] 🔍 サーチグラウンディング情報の決定:` - 最終的なサーチグラウンディング情報の決定

#### 期待される動作
- サーチグラウンディングが実際に使用された場合のみ、`(サーチ)`が表示される
- XMLタグに`search="true"`が含まれていても、実際にサーチグラウンディングが使われていない場合は`(サーチ)`が表示されない

### 4. 掛け合いターン数のテスト

#### テスト手順
1. サーチグラウンディングを使用した掛け合いを開始
   - 例: 「最新のVtuber情報を教えてサーチ」
2. 掛け合いが完了するまで待つ

#### 確認すべきログ
- `[handlers] 📊 掛け合いターン数:` - 各ターンのカウント
- `[handlers] 📊 掛け合いの最終統計:` - 最終的なターン数と要件達成状況

#### 期待される動作
- サーチグラウンディングを使用した掛け合いは、必ず7ターン以上になる
- 7ターン未満の場合は、ログに「❌ ターン数不足」と表示される

## ログの見方

### ログの記号の意味
- ✅: 成功、正常に動作
- ❌: 失敗、エラー、要件未達成
- 🔍: 検索、検出、判定
- 📝: 抽出、保存、処理
- 📊: 統計、カウント、集計
- ⚠️: 警告、注意が必要
- ℹ️: 情報、参考情報

### ログの構造
各ログは以下の形式で出力されます：
```
[モジュール名] 記号 メッセージ: { 詳細情報 }
```

例:
```
[handlers] ✅ 関連記憶をシステムプロンプトに注入: {
  memoryCount: 2,
  systemPromptLength: 5000,
  memories: [...]
}
```

## トラブルシューティング

### 記憶が抽出されない
- ログで `[memoryExtractor] 📝 会話から記憶を抽出:` を確認
- パターンマッチングが機能していない可能性がある
- より高度な自然言語処理が必要な場合がある

### サーチグラウンディングが検出されない
- `[vercel.ts]` のログを確認
- `hasSearchGrounding` が `false` の場合、実際にサーチグラウンディングが使われていない
- `useSearchGrounding: true` でも、実際には使われない場合がある（Geminiの判断）

### ターン数が7未満になる
- `[handlers] 📊 掛け合いの最終統計:` を確認
- システムプロンプトの指示が守られていない可能性がある
- システムプロンプトをさらに強化する必要がある場合がある

## テスト用のサンプルメッセージ

### 記憶システムのテスト
1. 「私の名前はルピナスです」
2. 「ルピナスについて教えて」

### サーチグラウンディングのテスト
1. 「最新のVtuber情報を教えてサーチ」
2. 「AIの最新情報を取り入れた漫才やってみて！サーチ」

### 掛け合いターン数のテスト
1. 「最新のゲーム情報を教えてサーチ」
2. 「もっと詳しく教えてサーチ」

## 注意事項

- ログは大量に出力されるため、フィルタリングを活用してください
- ブラウザのコンソールの履歴をクリアしてからテストを開始すると、見やすくなります
- ログのタイムスタンプを確認して、時系列を追跡してください

