# LUNA-AI 実装タスク管理

## 📋 タスク管理ルール

### 基本ルール
1. **タスク完了時**: `- [ ]` を `- [x]` に変更してチェックを入れる
2. **仕様書更新時**: このタスクファイルも必ず更新する
3. **整合性確認**: 週1回、仕様書（`SPECIFICATION.md`）とこのタスクファイルの整合性を確認する
4. **タスク追加時**: 仕様書の該当セクション番号を記載する
5. **タスク完了時**: 完了日を `[完了: YYYY-MM-DD]` の形式で追記する

### 仕様書との整合性チェック項目
- [ ] 仕様書の「実装予定機能」セクションとタスクが一致しているか
- [ ] 仕様書の「実装済み機能」セクションと完了タスクが一致しているか
- [ ] 仕様書の変更があった場合、タスクも更新されているか

---

## 🎯 実装タスク一覧（実装順）

> **目標**: 元々できていた掛け合いが出来る状態までを、chrome1タブで実現させる

---

### フェーズ1: 環境変数・基盤実装（最優先）

#### 1. 環境変数の実装（A/B分離対応）
**仕様書セクション**: `## 環境変数`  
**依存関係**: なし（最優先）

- [x] **1-1. キャラクター名・プロンプトファイルのA/B分離** [完了: 2024-XX-XX]
  - [x] `NEXT_PUBLIC_CHARACTER_A_NAME` 環境変数の実装（初期値: "アイリス・ロゼッティ"）
  - [x] `NEXT_PUBLIC_CHARACTER_B_NAME` 環境変数の実装（初期値: "フィオナ・ロゼッティ"）
  - [x] `NEXT_PUBLIC_PROMPT_FILE_A` 環境変数の実装（初期値: "./prompts/iris.txt"）
  - [x] `NEXT_PUBLIC_PROMPT_FILE_B` 環境変数の実装（初期値: "./prompts/fiona.txt"）
  - [x] プロンプトファイルの読み込み処理（A/B別々）- next.config.jsで実装
  - [x] `chatLog.tsx` のハードコードされたキャラクター名を環境変数に置き換え
  - [仕様書参照: 環境変数](#環境変数)

- [x] **1-2. 音声合成設定のA/B分離** [完了: 2024-XX-XX]
  - [x] `NEXT_PUBLIC_SELECT_VOICE_A` 環境変数の実装（初期値: "aivis_speech"）
  - [x] `NEXT_PUBLIC_SELECT_VOICE_B` 環境変数の実装（初期値: "aivis_speech"）
  - [x] `NEXT_PUBLIC_AIVIS_SPEECH_SPEAKER_A` 環境変数の実装（初期値: "997152320"）
  - [x] `NEXT_PUBLIC_AIVIS_SPEECH_SPEAKER_B` 環境変数の実装（初期値: "1132029248"）
  - [x] `NEXT_PUBLIC_VOICEVOX_SPEAKER_A` 環境変数の実装
  - [x] `NEXT_PUBLIC_VOICEVOX_SPEAKER_B` 環境変数の実装
  - [x] AivisSpeech の各パラメータ（Speed, Pitch, Intonation Scale など）のA/B分離
  - [x] VoiceVox の各パラメータ（Speed, Pitch, Intonation など）のA/B分離
  - [x] `settingsStore` にA/B別々の音声設定を追加
  - [仕様書参照: 音声合成](#音声合成tts)

- [x] **1-3. UI色設定の実装** [完了: 2024-XX-XX]
  - [x] `NEXT_PUBLIC_LISTENER_NAME` 環境変数の実装（初期値: "リスナー"）
  - [x] `NEXT_PUBLIC_LISTENER_*` 色設定環境変数の実装
  - [x] `NEXT_PUBLIC_CHARACTER_A_*` 色設定環境変数の実装
  - [x] `NEXT_PUBLIC_CHARACTER_B_*` 色設定環境変数の実装
  - [x] `NEXT_PUBLIC_STREAMER_*` 色設定環境変数の実装
  - [x] `uiColors` オブジェクトの環境変数からの読み込み実装
  - [仕様書参照: UI構成](#ui-構成掛け合いモード)

- [x] **1-4. settingsStore の更新** [完了: 2024-XX-XX]
  - [x] A/B別々のキャラクター名を `settingsStore` に追加
  - [x] A/B別々のプロンプトファイル読み込み処理を実装
  - [x] A/B別々の音声設定を `settingsStore` に追加
  - [x] 全環境変数の初期値設定を `getInitialValuesFromEnv` に追加
  - [x] `partialize` に新しい環境変数を追加
  - [仕様書参照: データ保存](#データ保存)

---

### フェーズ2: XMLパース・データ処理（掛け合いの基盤）

#### 2. Gemini XML 出力形式のパース
**仕様書セクション**: `## Gemini XML 出力形式`  
**依存関係**: タスク1完了後

- [x] **2-1. XML パーサーの実装** [完了: 2024-XX-XX]
  - [x] Gemini の XML 出力をパースする関数作成 - `xmlParser.ts` を作成
  - [x] `<A>` タグ（アイリス）の抽出
  - [x] `<B>` タグ（フィオナ）の抽出
  - [x] `emotion` 属性の取得
  - [仕様書参照: Gemini XML出力形式](#gemini-xml-出力形式)

- [x] **2-2. パース結果の処理** [完了: 2024-XX-XX]
  - [x] パースした内容を対応するキャラクターに送信 - `processAIResponse` に統合
  - [x] 感情タグを Live2D アニメーションに反映 - `handleSpeakAndStateUpdateForCharacter` で実装
  - [x] エラーハンドリング（不正なXML形式への対応） - `extractCompleteXMLTags` で実装
  - [仕様書参照: パース処理](#パース処理)

- [x] **2-3. Gemini への指示プロンプト実装** [完了: 2024-XX-XX]
  - [x] XML 形式で出力するよう指示するプロンプト作成 - `handleSendChatFn` に追加
  - [x] 掛け合い生成ロジックの実装 - システムプロンプトにXML指示を追加
  - [x] 文字数制約（500文字以内）の管理 - プロンプトに記載
  - [仕様書参照: 掛け合い生成ロジック](#掛け合い生成ロジック)

---

### フェーズ3: UI実装（1タブ2体表示）

#### 3. 1タブ2体表示機能
**仕様書セクション**: `## UI 構成（掛け合いモード）`  
**依存関係**: タスク1, 2完了後

- [ ] **3-1. キャラクター表示エリアの実装**
  - [ ] アイリス（左側または上側）の表示位置設定
  - [ ] フィオナ（右側または下側）の表示位置設定
  - [ ] 各キャラクターの独立した Live2D インスタンス作成
  - [ ] レイアウトのレスポンシブ対応
  - [仕様書参照: UI構成](#ui-構成掛け合いモード)

- [ ] **3-2. 統合セリフ枠の実装**
  - [ ] 1つの統合されたセリフ枠コンポーネント作成
  - [ ] 現在話しているキャラクターのセリフを表示
  - [ ] キャラクター名とセリフを区別して表示（色分け・アイコン）
  - [ ] セリフの切り替えアニメーション
  - [仕様書参照: UI構成 - セリフ枠](#ui-構成掛け合いモード)

- [ ] **3-3. 統合会話ログの実装**
  - [ ] 1つの統合された会話ログコンポーネント作成
  - [ ] アイリスとフィオナの両方の会話を時系列で表示
  - [ ] キャラクター名で色分けまたはアイコン表示
  - [ ] スクロール位置の自動調整
  - [仕様書参照: UI構成 - 会話ログ](#ui-構成掛け合いモード)

---

### フェーズ4: 音声合成実装（2体が別々に話す）

#### 4. 独立した音声合成機能
**仕様書セクション**: `## 音声合成（TTS）`  
**依存関係**: タスク1, 2, 3完了後

- [ ] **4-1. アイリス用音声合成の実装**
  - [ ] アイリス専用の音声設定（AivisSpeech/VoiceVox）を個別に管理
  - [ ] アイリスのセリフを独立して読み上げ
  - [ ] アイリス用の音声キュー管理
  - [仕様書参照: 音声合成の動作](#音声合成の動作掛け合いモード)

- [ ] **4-2. フィオナ用音声合成の実装**
  - [ ] フィオナ専用の音声設定（AivisSpeech/VoiceVox）を個別に管理
  - [ ] フィオナのセリフを独立して読み上げ
  - [ ] フィオナ用の音声キュー管理
  - [仕様書参照: 音声合成の動作](#音声合成の動作掛け合いモード)

- [ ] **4-3. 音声合成の同時実行制御**
  - [ ] 2つのキャラクターが同時に話さないように制御
  - [ ] 音声キューの優先順位管理
  - [ ] 音声の重複防止ロジック
  - [仕様書参照: 音声合成の動作](#音声合成の動作掛け合いモード)

---

### フェーズ5: Live2Dアニメーション実装（2体が別々に動く）

#### 5. 独立した Live2D アニメーション機能
**仕様書セクション**: `## Live2D アニメーション`  
**依存関係**: タスク1, 3, 4完了後

- [ ] **5-1. アイリス用 Live2D の実装**
  - [ ] アイリス専用の Live2D インスタンス作成
  - [ ] アイリスの感情タグに基づく独立したアニメーション
  - [ ] アイリスのリップシンク（音声に同期）
  - [仕様書参照: Live2Dアニメーション](#live2d-アニメーション)

- [ ] **5-2. フィオナ用 Live2D の実装**
  - [ ] フィオナ専用の Live2D インスタンス作成
  - [ ] フィオナの感情タグに基づく独立したアニメーション
  - [ ] フィオナのリップシンク（音声に同期）
  - [仕様書参照: Live2Dアニメーション](#live2d-アニメーション)

- [ ] **5-3. 2体同時アニメーション制御**
  - [ ] 2つの Live2D インスタンスの同時動作制御
  - [ ] リソース管理（メモリ・CPU負荷対策）
  - [仕様書参照: Live2Dアニメーション](#live2d-アニメーション)

---

### フェーズ6: その他の環境変数・設定（後回し可能）

#### 6. その他の環境変数の実装
**仕様書セクション**: `## 環境変数`  
**依存関係**: タスク1完了後（優先度低）

- [ ] **6-1. 共通環境変数の追加・更新**
  - [ ] `NEXT_PUBLIC_MODEL_TYPE` 環境変数の実装（初期値: "live2d"）
  - [ ] `NEXT_PUBLIC_CUSTOM_PRESET_NAME1-5` 環境変数の実装
  - [ ] `NEXT_PUBLIC_CHARACTER_PRESET1-5` 環境変数の実装
  - [ ] `NEXT_PUBLIC_SELECTED_VRM_PATH` 環境変数の実装（初期値: "/vrm/nikechan_v2.vrm"）
  - [ ] `NEXT_PUBLIC_SELECTED_LIVE2D_PATH` 環境変数の実装（初期値: "/live2d/iris/iris.model3.json"）
  - [ ] `NEXT_PUBLIC_LIGHTING_INTENSITY` 環境変数の実装（初期値: "1.0"）
  - [ ] Live2D感情設定環境変数の実装（NEUTRAL, HAPPY, SAD, ANGRY, RELAXED, SURPRISED）
  - [ ] Live2Dモーショングループ設定環境変数の実装
  - [仕様書参照: 環境変数](#環境変数)

- [ ] **6-2. AI設定の環境変数実装**
  - [ ] `NEXT_PUBLIC_SELECT_AI_MODEL` 環境変数の実装（初期値: "gemini-2.0-flash"）
  - [ ] `NEXT_PUBLIC_MAX_PAST_MESSAGES` 環境変数の実装（初期値: 25）
  - [ ] `NEXT_PUBLIC_TEMPERATURE` 環境変数の実装（初期値: 0.7）
  - [ ] `NEXT_PUBLIC_MAX_TOKENS` 環境変数の実装（初期値: 4096）
  - [ ] `NEXT_PUBLIC_USE_SEARCH_GROUNDING` 環境変数の実装（初期値: "true"、OFF可能にする）
  - [ ] `NEXT_PUBLIC_DYNAMIC_RETRIEVAL_THRESHOLD` 環境変数の実装
  - [仕様書参照: AI設定](#ai-設定)

- [ ] **6-3. その他設定の環境変数実装**
  - [ ] `NEXT_PUBLIC_EXTERNAL_LINKAGE_MODE` 環境変数の実装（初期値: "false"）
  - [ ] `NEXT_PUBLIC_SPEECH_RECOGNITION_MODE` 環境変数の実装（初期値: "browser"）
  - [ ] `NEXT_PUBLIC_YOUTUBE_MODE` 環境変数の実装（初期値: "true"）
  - [ ] `NEXT_PUBLIC_SLIDE_MODE` 環境変数の実装（初期値: "false"）
  - [ ] その他の細かい設定環境変数
  - [仕様書参照: その他の設定](#その他の設定)

---

### フェーズ7以降: 企画システム・最適化（掛け合い動作後）

#### 7. コメント接頭辞システム
**仕様書セクション**: `## コメント接頭辞システム`  
**依存関係**: タスク1-5完了後

- [ ] **7-1. 接頭辞検出機能**
  - [ ] `IR****` の検出（アイリス宛）
  - [ ] `FI****` の検出（フィオナ宛）
  - [ ] `#xx` の検出（企画提案）
  - [ ] `/xx` の検出（企画参加コマンド）
  - [仕様書参照: 接頭辞一覧](#接頭辞一覧)

- [ ] **7-2. 正規化機能**
  - [ ] 大文字小文字の正規化（`IR` = `ir` = `Ir`）
  - [ ] 全角半角の正規化（`ＩＲ` = `IR`）
  - [ ] 表記揺れの許容
  - [仕様書参照: 正規化ルール](#正規化ルール)

- [ ] **7-3. モード別ルーティング**
  - [ ] 単体モードAでの反応ルール
  - [ ] 単体モードBでの反応ルール
  - [ ] 掛け合いモードでの反応ルール
  - [仕様書参照: 動作モード別の反応](#動作モード別の反応)

#### 8. 企画システム（状態マシン）
**仕様書セクション**: `## 企画システム（状態マシン）`  
**依存関係**: タスク7完了後

- [ ] **8-1. 状態マシンの実装**
  - [ ] 状態定義（Normal, ProposalPending, ProjectIntro, ProjectRunning, ProjectResult）
  - [ ] 状態遷移ロジックの実装
  - [ ] 状態ごとのコメント反応ルール実装
  - [仕様書参照: 状態遷移図](#状態遷移図)

- [ ] **8-2. 提案待機機能**
  - [ ] `#xx` コメントの検出
  - [ ] AI による提案読み上げ
  - [ ] ルピナスの判断待ち状態の管理
  - [仕様書参照: 提案待機中](#2-提案待機中-proposalpending)

- [ ] **8-3. 企画実行機能**
  - [ ] `/xx` コマンドの検出とルーティング
  - [ ] 企画タイプ別の処理分岐
  - [ ] 企画進行状態の管理
  - [仕様書参照: 企画実行中](#4-企画実行中-projectrunning)

- [ ] **8-4. 企画リザルト機能**
  - [ ] 結果発表の実装
  - [ ] 通常モードへの自動遷移
  - [仕様書参照: 企画リザルト](#5-企画リザルト-projectresult)

#### 9. 設定画面の更新
**仕様書セクション**: `## 設定画面`  
**依存関係**: タスク1完了後

- [ ] **9-1. キャラクター設定の分離**
  - [ ] アイリス用設定タブ/セクション
  - [ ] フィオナ用設定タブ/セクション
  - [仕様書参照: キャラクター設定](#キャラクター設定)

- [ ] **9-2. 音声設定の分離**
  - [ ] アイリス用音声設定（個別）
  - [ ] フィオナ用音声設定（個別）
  - [仕様書参照: 音声設定](#音声設定)

- [ ] **9-3. データ保存の分離**
  - [ ] アイリス用設定の個別保存
  - [ ] フィオナ用設定の個別保存
  - [仕様書参照: データ保存](#データ保存)

#### 10. Search Grounding の動的制御
**仕様書セクション**: `## Search Grounding（検索機能）`  
**依存関係**: タスク1完了後

- [ ] **10-1. 使用判定ロジック**
  - [ ] 最新情報が必要な場合の判定
  - [ ] 固有名詞（ゲーム、アニメ、流行など）の検出
  - [ ] 知識不足の判定
  - [仕様書参照: 使用方針](#使用方針)

- [ ] **10-2. 使用しないタイミングの判定**
  - [ ] 漫才のネタ中の検出
  - [ ] クイズ中の検出
  - [ ] 恋バナ中の検出
  - [ ] 自然な会話の流れの判定
  - [仕様書参照: 使用しないタイミング](#使用しないタイミング)

- [ ] **10-3. API パラメータの動的制御**
  - [ ] `useSearchGrounding` の動的設定
  - [ ] フォールバック処理の実装
  - [仕様書参照: 実装仕様](#実装仕様)

#### 11. 起動スクリプトの更新
**仕様書セクション**: `## 起動方法`  
**依存関係**: タスク1-5完了後

- [ ] **11-1. 単体モードA用スクリプト**
  - [ ] `start_A_dev.bat` の作成/更新
  - [ ] ポート3000での起動確認
  - [仕様書参照: 単体モードA](#1-単体モードastart_a_devbat)

- [ ] **11-2. 単体モードB用スクリプト**
  - [ ] `start_B_dev.bat` の作成/更新
  - [ ] ポート3001での起動確認
  - [仕様書参照: 単体モードB](#2-単体モードbstart_b_devbat)

- [ ] **11-3. 掛け合いモード用スクリプト**
  - [ ] `start_dev.bat` の更新
  - [ ] 1タブ2体表示での起動確認
  - [仕様書参照: 掛け合いモード](#3-掛け合いモードstart_devbat)

#### 12. パフォーマンス最適化
**依存関係**: タスク1-5完了後

- [ ] **12-1. 2体同時表示の最適化**
  - [ ] Live2D インスタンスのメモリ管理
  - [ ] レンダリング負荷の軽減
  - [ ] フレームレートの維持

- [ ] **12-2. 音声合成の最適化**
  - [ ] 2つの音声キューの効率的な管理
  - [ ] 音声バッファの最適化
  - [ ] 遅延の最小化

#### 13. テスト・デバッグ
**依存関係**: 各タスク完了後

- [ ] **13-1. 単体テスト**
  - [ ] XML パーサーのテスト
  - [ ] 状態マシンのテスト
  - [ ] コメント接頭辞システムのテスト

- [ ] **13-2. 統合テスト**
  - [ ] 1タブ2体表示の動作確認
  - [ ] 掛け合いモードの動作確認
  - [ ] 企画システムの動作確認

- [ ] **13-3. エラーハンドリング**
  - [ ] XML パースエラーの処理
  - [ ] 音声合成エラーの処理
  - [ ] Live2D アニメーションエラーの処理

---

## 📊 進捗状況

### 全体進捗
- **総タスク数**: 約 80 タスク
- **完了タスク数**: 0 タスク
- **進捗率**: 0%

### フェーズ別進捗
- **フェーズ1（環境変数・基盤）**: 0/4 (0%)
- **フェーズ2（XMLパース）**: 0/3 (0%)
- **フェーズ3（UI実装）**: 0/3 (0%)
- **フェーズ4（音声合成）**: 0/3 (0%)
- **フェーズ5（Live2D）**: 0/3 (0%)
- **フェーズ6以降**: 0/30 (0%)

### 目標達成状況
- [ ] **フェーズ1-5完了**: 掛け合いが1タブで動作する状態 ✅ 目標

---

## 📝 変更履歴

### 2024-XX-XX
- タスク管理ファイル作成
- 仕様書（`SPECIFICATION.md`）から実装予定機能を抽出
- 環境変数実装タスクを追加（A/B分離対応、音声合成、UI設定など）
- **タスクを実装順に並べ替え**（フェーズ1-5で掛け合い動作を実現）

---

## 🔗 関連ファイル

- **仕様書**: `SPECIFICATION.md`
- **環境変数例**: `example.env`
- **起動スクリプト**: `start_dev.bat`, `start_A_dev.bat`, `start_B_dev.bat`

---

## 💡 メモ

### 実装順序の考え方
1. **フェーズ1**: 環境変数がないと他の機能が動かない → 最優先
2. **フェーズ2**: XMLパースがないと掛け合いデータが処理できない → 次優先
3. **フェーズ3-5**: UI、音声、Live2D の順で実装 → 掛け合い動作の完成
4. **フェーズ6以降**: 企画システムなどは掛け合い動作後に実装

### 依存関係
- タスク1（環境変数）→ 全タスクの基盤
- タスク2（XMLパース）→ タスク3-5の前提
- タスク3（UI）→ タスク4-5の前提
- タスク4（音声）→ タスク5と連携
- タスク5（Live2D）→ タスク4と連携

---

**最終更新**: 2024-XX-XX
