# コメントキューシステム実装計画（更新版）

## 概要

YouTubeコメントをキューで管理し、対応中モードと対応受付中モードを切り替えながら順次処理するシステムを実装します。
また、企画システム（なぞなぞ企画）とBGM/SE/画面エフェクト機能も実装します。

## 実装方針

### 1. 状態管理

#### 1.1 アプリケーション状態
- **対応中モード (Processing)**: AIが掛け合いや読み上げを実行中
- **対応受付中モード (Accepting)**: 新しいコメントを受け付け可能

#### 1.2 企画モード状態
- **通常モード (Normal)**: 通常のコメント処理
- **企画提案待機中 (ProposalPending)**: 企画提案を読み上げ、承認待ち
- **企画紹介中 (ProjectIntro)**: 企画の説明中
- **企画実行中 (ProjectRunning)**: 企画進行中
- **企画リザルト (ProjectResult)**: 結果発表中

### 2. コメントキュー構造

```typescript
interface QueuedComment {
  id: string // 一意のID（タイムスタンプ + ランダム文字列）
  timestamp: number // キューに入った時刻
  userName: string // リスナー名
  userIconUrl: string // アイコンURL
  comment: string // コメント本文
  characterId: 'A' | 'B' | undefined // キャラクターID
  message: string // 接頭辞を除去したメッセージ
  priority: 'high' | 'low' // 優先度（IR/FI = high, #xx/xx = low）
  prefixType: 'character' | 'project-proposal' | 'project-command' | 'none' // 接頭辞タイプ
}
```

### 3. キュー管理ロジック

#### 3.1 コメントの分類と優先度
- **高優先度 (high)**:
  - `IR****` (キャラクターA宛)
  - `FI****` (キャラクターB宛)
- **低優先度 (low)**:
  - `#xx` (企画提案、例: `#NZ`, `#riddle`など)
  - `/xx` (企画参加コマンド、例: `/NZ`, `/answer`など)

#### 3.2 接頭辞の仕様
- **アルファベット部分**: 2文字（例: `NZ`, `riddle`）
- **大文字小文字**: 区別しない（`#NZ` = `#nz` = `#Nz`）
- **全角半角**: 対応（`＃ＮＺ` = `#NZ`）
- **アルファベットの次**: 何が来てもOK（`#NZ123`, `#NZ なぞなぞ`など）

#### 3.3 モード別のキュー処理ルール

##### 通常モード (Normal)
- **IR/FI**: 高優先度でキューに追加
- **#xx**: 低優先度でキューに追加
- **/xx**: 破棄
- **接頭辞なし**: 破棄

##### 提案待機中 (ProposalPending)
- **IR/FI**: 高優先度でキューに追加（キューに残したまま）
- **#xx**: 低優先度でキューに追加（キューに残したまま）
- **/xx**: 破棄
- **接頭辞なし**: 破棄
- **企画紹介中に移行**: キュー内の全コメントを削除
- **通常に戻る**: キュー内のコメントは残したまま

##### 企画紹介中 (ProjectIntro)
- **全てのコメント**: 破棄
- **キュー内**: 全て削除

##### 企画実行中 (ProjectRunning)
- **/xx**: キューに追加（一部企画のみ接頭辞なしも可、基本は破棄）
- **IR/FI**: 破棄
- **#xx**: 破棄
- **接頭辞なし**: 基本は破棄（一部企画のみ可）

##### 企画リザルト (ProjectResult)
- **全てのコメント**: 破棄
- **キュー内**: 全て削除

#### 3.4 キューからの処理
1. 対応受付中モードになったら、キューが空になるまで処理
2. 高優先度コメントを優先的に処理
3. 同じ優先度内では古い順（FIFO）
4. 同じリスナーからの回答は最新のみ保持（古いものは削除）

### 4. 状態遷移フロー

```
[対応受付中] → コメント処理開始 → [対応中]
     ↑                                    ↓
     └──────── 処理完了 ────────────────┘
```

### 5. 企画システムとの連携

#### 5.1 企画開始時の動作
- キュー内の全コメントをクリア
- 企画モードに遷移（ProjectRunning）

#### 5.2 企画終了時の動作
- 企画モードから通常モードに戻る
- 対応受付中モードに遷移

### 6. なぞなぞ企画の実装

#### 6.1 企画タイプ: `#NZ`

**流れ**:
1. リスナーが `#NZ` を送信
2. **提案待機中**: ルピナスに提案が来ていることを問う掛け合い（固定セリフ）
3. **ルピナスの承認**: チャット欄からの肯定メッセージまたはUIボタンで承認
4. **企画紹介中**: 企画の説明の掛け合い（固定セリフ）
5. **企画実行中**: 
   - リスナーが `/NZ [回答]` で回答（キューに保存）
   - 同じリスナーからの回答は最新のみ保持、古いものは削除
   - ヒントを出したり、キューの中の不正解を抜粋して感じたことを話す掛け合い（ランダム実行）
6. **企画リザルト**: 
   - キューの中の全てを画面に表示
   - 正解/不正解の判定と結果発表（掛け合い）
7. 通常モードに戻る

**実装内容**:
- なぞなぞの問題と答えを管理するデータ構造（サーチグラウンディングで自動生成も可）
- 回答の判定ロジック
- 企画状態の管理
- 固定セリフの管理
- ランダムな掛け合いの生成

### 7. ルピナスの承認システム

#### 7.1 承認方法
1. **チャット欄からの肯定メッセージ**:
   - 肯定キーワードの判定（例: "はい", "OK", "承認", "やる", "いいよ"など）
   - 音声認識からの肯定メッセージも対応

2. **UIボタンでの承認**:
   - 企画ボタン用アコーディオンメニューを作成
   - 各企画毎にボタンを配置
   - ボタンを押すと、全てを中断して企画が始まる

#### 7.2 企画ボタンUI
- アコーディオンメニュー形式
- 各企画タイプ（#NZなど）に対応するボタン
- ボタンクリックで即座に企画開始（キュー処理を中断）

### 8. BGM/SE/画面エフェクトシステム

#### 8.1 機能概要
- キャストクラフトのようなBGM、SE、画面エフェクト機能
- UI上に専用のボタンを作成
- ボタンを押すと効果が発生

#### 8.2 実装方法
- **BGM**: Web Audio APIを使用して音楽ファイルを再生
- **SE**: Web Audio APIを使用して効果音を再生
- **画面エフェクト**: CSSアニメーションまたはCanvas/WebGLを使用

#### 8.3 UI構成
- メニューに「エフェクト」ボタンを追加
- アコーディオンメニューでBGM/SE/画面エフェクトを選択
- 各エフェクトに開始/停止ボタン

### 9. 実装ファイル構成

```
src/features/youtube/
  ├── commentQueue.ts          # キュー管理ロジック
  ├── commentQueueStore.ts     # キュー状態管理（Zustand）
  ├── projectModeStore.ts       # 企画モード状態管理（Zustand）
  ├── projects/
  │   ├── nzProject.ts          # なぞなぞ企画の実装
  │   ├── projectTypes.ts       # 企画タイプ定義
  │   └── projectScripts.ts     # 固定セリフ管理
  └── youtubeComments.ts        # 既存ファイル（修正）

src/features/effects/
  ├── bgmManager.ts             # BGM管理
  ├── seManager.ts              # SE管理
  └── screenEffectManager.ts    # 画面エフェクト管理

src/components/
  ├── projectButtonMenu.tsx     # 企画ボタン用アコーディオンメニュー
  ├── effectButtonMenu.tsx      # エフェクトボタン用アコーディオンメニュー
  └── (既存のコンポーネント)
```

### 10. 実装ステップ

#### ステップ1: 基本構造の実装
1. `commentQueueStore.ts` の作成（キュー状態管理）
2. `projectModeStore.ts` の作成（企画モード状態管理）
3. `commentQueue.ts` の作成（キュー操作関数）
4. 接頭辞解析の拡張（#xx, /xxの正規化）

#### ステップ2: コメント処理の修正
1. `youtubeComments.ts` の修正
   - リスナー名の取得（既に実装済み）
   - コメントの分類と優先度判定
   - モード別のキュー処理ルール実装
   - 同じリスナーからの回答の最新のみ保持ロジック

#### ステップ3: キュー処理の実装
1. `useYoutube.tsx` の修正
   - 対応中/対応受付中モードの判定（`chatProcessing`フラグを使用）
   - キューからの処理ロジック
   - キューが空になるまで繰り返し処理

#### ステップ4: 企画システムの基本実装
1. `projectTypes.ts` の作成
2. `projectScripts.ts` の作成（固定セリフ管理）
3. 企画開始/終了時のキュークリア処理
4. ルピナスの承認判定ロジック（肯定メッセージの検出）

#### ステップ5: なぞなぞ企画の実装
1. `nzProject.ts` の作成
2. なぞなぞの問題管理（JSONファイルまたはコード内配列）
3. サーチグラウンディングでの自動生成機能
4. 回答判定ロジック
5. 固定セリフの実装（提案待機中、企画紹介中、企画リザルト）
6. ランダムな掛け合いの実装（企画実行中）

#### ステップ6: UI実装
1. `projectButtonMenu.tsx` の作成（企画ボタン用アコーディオンメニュー）
2. `menu.tsx` への統合
3. 企画ボタンクリック時の処理（全中断して企画開始）

#### ステップ7: BGM/SE/画面エフェクトの実装
1. `bgmManager.ts` の作成（Web Audio API）
2. `seManager.ts` の作成（Web Audio API）
3. `screenEffectManager.ts` の作成（CSS/Canvas）
4. `effectButtonMenu.tsx` の作成
5. `menu.tsx` への統合

#### ステップ8: 統合とテスト
1. 全体の統合
2. 動作確認とデバッグ
3. パフォーマンス最適化

## 注意事項

1. **既存機能との互換性**: 現在のコメント処理機能を壊さないように注意
2. **パフォーマンス**: キューが大きくなりすぎないように制限を設ける（例: 最大100件）
3. **エラーハンドリング**: キュー処理中のエラーが全体に影響しないようにする
4. **ログ出力**: デバッグのため、キュー操作のログを適切に出力

## 確認済み事項

1. ✅ キューの最大サイズ: 100件
2. ✅ 対応中モードの判定: `chatProcessing`フラグで十分
3. ✅ なぞなぞの問題: JSONファイルまたはコード内の配列（サーチグラウンディングで自動生成も可）
4. ✅ 企画の承認: ルピナスの手動承認（チャット欄からの肯定メッセージまたはUIボタン）

## 追加確認事項

### 1. BGM/SE/画面エフェクトについて
- ✅ **BGM/SEファイルの配置場所**: `public/audio/bgm/`, `public/audio/se/`
- ✅ **画面エフェクトの種類**: パーティクル、画面揺れ、色変化など、実装できるだけいろいろ実装
- ✅ **エフェクトのタイミング**: ルピナスがボタンで手動で押すことを基本、企画開始時・正解時・不正解時に特定のSEも鳴らす

### 2. なぞなぞ企画について
- ✅ **問題の数**: 100問
- ✅ **サーチグラウンディングでの自動生成**: 会話履歴からランダムにジャンルを選び、それにちなんだなぞなぞを出す
- ✅ **ヒントの出し方**: 企画実行中に2分くらいで1回掛け合いでヒント、簡単そうな場合は不正解を抜粋して面白おかしく掛け合い

### 3. 固定セリフについて
- ✅ **提案待機中のセリフ**: `PROJECT_SCRIPTS_PROPOSAL.md`に提案済み
- ✅ **企画紹介中のセリフ**: `PROJECT_SCRIPTS_PROPOSAL.md`に提案済み（回答接頭辞の説明を含む）
- ✅ **企画リザルトのセリフ**: `PROJECT_SCRIPTS_PROPOSAL.md`に提案済み
- ✅ **否定時のセリフ**: `PROJECT_SCRIPTS_PROPOSAL.md`に提案済み

### 4. ルピナスの承認判定について
- ✅ **肯定キーワード**: `PROJECT_SCRIPTS_PROPOSAL.md`に拡張版リストを記載
- ✅ **否定キーワード**: `PROJECT_SCRIPTS_PROPOSAL.md`にリストを記載、固定セリフの掛け合い後に通常モードに戻る

### 5. 企画ボタンUIについて
- ✅ **アコーディオンメニューの位置**: 右下あたり
- ✅ **ボタンのデザイン**: 文字でOK

## 実装可能性の確認

✅ **実装可能な機能**:
- コメントキューシステム
- 状態管理（対応中/対応受付中、企画モード）
- 接頭辞の正規化（#NZ, /NZなど）
- 同じリスナーからの回答の最新のみ保持
- 固定セリフの実装
- ルピナスの承認判定（チャット欄またはUIボタン）
- 企画ボタン用アコーディオンメニュー
- なぞなぞ企画の基本機能

⚠️ **新規実装が必要な機能**:
- BGM/SE/画面エフェクトシステム（Web Audio API、CSS/Canvas実装が必要）
- サーチグラウンディングでのなぞなぞ自動生成（プロンプト設計が必要）

## 実装準備完了 ✅

すべての確認事項が完了しました。以下の内容で実装を開始します：

### 実装内容まとめ

1. **コメントキューシステム**
   - 対応中/対応受付中モードの実装
   - キュー管理（最大100件）
   - 優先度管理（IR/FI = 高優先度、#xx = 低優先度）
   - 同じリスナーからの回答の最新のみ保持

2. **企画システム**
   - 状態管理（通常/提案待機中/企画紹介中/企画実行中/企画リザルト）
   - モード別のキュー処理ルール
   - ルピナスの承認判定（肯定/否定キーワード）
   - 固定セリフの実装

3. **なぞなぞ企画**
   - 100問の問題管理
   - サーチグラウンディングでの自動生成
   - ヒント機能（2分ごと、または不正解を抜粋）
   - 回答判定と結果発表

4. **UI実装**
   - 企画ボタン用アコーディオンメニュー（右下）
   - エフェクトボタン用アコーディオンメニュー

5. **BGM/SE/画面エフェクト**
   - Web Audio API実装
   - CSS/Canvas実装
   - 手動ボタン + 自動再生（企画開始時・正解時・不正解時）

実装を開始しますか？それとも、追加の確認事項や修正があれば教えてください。

