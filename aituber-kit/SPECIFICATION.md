# LUNA-AI プロジェクト仕様書

## 概要

LUNA-AI は、Google Gemini と AivisSpeech/VoiceVox を使用した AI キャラクター対話システムです。
Next.js ベースのフロントエンドアプリケーションとして実装されており、**Python バックエンドは使用していません**。

**AI Bloom Sisters（AIBS）** として、アイリス・ロゼッティとフィオナ・ロゼッティの2体の AI キャラクターが、1つのブラウザタブ内で同時に動作し、掛け合いや企画を進行します。

---

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14.2.5
- **言語**: TypeScript 5.0.2
- **UI ライブラリ**: React 18.3.1
- **状態管理**: Zustand 4.5.4
- **3D レンダリング**: Three.js 0.167.1
- **スタイリング**: Tailwind CSS 3.4.14

### AI・音声合成
- **AI モデル**: Google Gemini 2.0-flash（固定）
- **AI SDK**: Vercel AI SDK 4.1 + @ai-sdk/google 1.0.3
- **音声合成エンジン**: 
  - AivisSpeech（デフォルト）
  - VoiceVox

### バックエンド
- **Python バックエンド**: **削除済み**（Next.js のみで動作）

---

## キャラクター設定

### 主要キャラクター

#### ルピナス・ロゼッティ (User/Streamer)
- **役割**: 人間の配信者
- **機能**: システムを操作し、企画を進行する
- **入力方法**: チャット入力または音声入力

#### アイリス・ロゼッティ (Character A)
- **役割**: AI キャラクター（次女）
- **性格**: 元気いっぱいでちょっとおバカなルピナスの妹、フィオナと双子
- **口調**: 明るく元気でハイテンション、テンポよくノリよく喋る
- **一人称**: あたし
- **視聴者呼称**: みんな（全体）、名前+さん（個人）
- **プロンプトファイル**: `prompts/iris.txt`

#### フィオナ・ロゼッティ (Character B)
- **役割**: AI キャラクター（三女）
- **性格**: おとなしめで博識なルピナスの妹、アイリスと双子
- **口調**: 丁寧で柔らかい敬語、語尾に「ね」をよく使う
- **一人称**: わたし
- **視聴者呼称**: みなさん（全体）、名前+さん（個人）
- **プロンプトファイル**: `prompts/fiona.txt`

---

## 動作モード

### 1. 単体モードA（`start_A_dev.bat`）

- **アクティブキャラ**: アイリスのみ
- **ポート**: 3000
- **応答最大文字数**: 250文字
- **表示**: 1タブにアイリス1体のみ表示
- **用途**: アイリス単体での配信・対話

### 2. 単体モードB（`start_B_dev.bat`）

- **アクティブキャラ**: フィオナのみ
- **ポート**: 3001
- **応答最大文字数**: 250文字
- **表示**: 1タブにフィオナ1体のみ表示
- **用途**: フィオナ単体での配信・対話

### 3. 掛け合いモード（`start_dev.bat`）

- **アクティブキャラ**: アイリスとフィオナの両方
- **ポート**: 3000（1タブ内に2体表示）
- **応答最大文字数**: 合計500文字（A+B合計）
- **ターン数**: 無制限（合計が500文字以内であれば）
- **表示**: **1タブにアイリスとフィオナの2体を同時表示**
  - セリフ枠は1つに統合
  - 会話ログは1つに統合
  - 各キャラクターは別々に読み上げ
  - 各キャラクターは別々にリップシンク・Live2D アニメーション
- **用途**: 2体での掛け合い、企画進行

---

## UI 構成（掛け合いモード）

### 1タブ2体表示の仕様

- **キャラクター表示エリア**: 
  - アイリス（左側または上側）
  - フィオナ（右側または下側）
  - 各キャラクターは独立した Live2D インスタンス

- **セリフ枠**: 
  - **1つの統合されたセリフ枠**
  - 現在話しているキャラクターのセリフを表示
  - キャラクター名とセリフを区別して表示

- **会話ログ**: 
  - **1つの統合された会話ログ**
  - アイリスとフィオナの両方の会話を時系列で表示
  - キャラクター名で色分けまたはアイコン表示

- **音声合成**: 
  - アイリスとフィオナは**別々に読み上げ**
  - 各キャラクターの音声設定（AivisSpeech/VoiceVox）を個別に適用

- **Live2D アニメーション**: 
  - アイリスとフィオナは**別々にリップシンク・アニメーション**
  - 各キャラクターの感情タグに基づいて独立して動作

---

## Gemini XML 出力形式

### システムプロンプト指示

Gemini には、XML タグのみを出力するよう指示します：

```xml
<A emotion="happy">やっほー！お姉ちゃん、今日はどんな話する？</A>
<B emotion="relaxed">ふふ、アイリスちゃん、楽しみですねぇ。</B>
<A emotion="surprised">えぇ！？フィオナ、何か企んでるの！？</A>
```

### XML タグ仕様

- **`<A>`**: アイリスのセリフ
- **`<B>`**: フィオナのセリフ
- **`emotion` 属性**: `neutral`, `happy`, `angry`, `sad`, `relaxed`, `surprised` のいずれか

### パース処理

1. Gemini の出力を XML パーサーで解析
2. `<A>` と `<B>` タグを順次処理
3. 各タグの内容を対応するキャラクターに送信
4. 感情タグを Live2D アニメーションに反映

---

## 企画システム（状態マシン）

### 状態遷移図

```
通常モード
    ↓ (視聴者が #xx を送信)
提案待機中（AIが提案を読み上げ、ルピナスの判断を待つ）
    ↓ (ルピナスが承認)
企画紹介（AIがルールを説明）
    ↓
企画実行中（視聴者が /xx コマンドで参加）
    ↓
企画リザルト（AIが結果を発表）
    ↓
通常モード
```

### 状態詳細

#### 1. 通常モード (Normal)
- **基本状態**
- **反応するコメント**:
  - `IR****`: アイリス宛メッセージ
  - `FI****`: フィオナ宛メッセージ
  - `#xx`: 企画提案（例: `#quiz`、`#story`）
- **無視するコメント**: 上記以外

#### 2. 提案待機中 (ProposalPending)
- **状態**: `#xx` コメントを受け、AIが提案を読み上げた後、ルピナスの判断待ち
- **反応する入力**: ルピナスの入力のみ（提案を受ける/受けない）
- **無視する入力**: YouTubeコメント全般

#### 3. 企画紹介 (ProjectIntro)
- **状態**: 企画採用後、キャラA/Bが企画説明を行う
- **反応**: なし（説明中）

#### 4. 企画実行中 (ProjectRunning)
- **状態**: `/xx` コメントを受けて企画を進行
- **反応するコメント**: `/xx` (回答接頭辞)。一部企画は接頭辞なしも可
- **無視するコメント**: 通常モード向けコメント

#### 5. 企画リザルト (ProjectResult)
- **状態**: 結果発表
- **動作**: 完了後に Normal へ遷移

---

## 企画タイプ（計画中）

### 1. クイズゲーム
- AIが質問を出題
- 視聴者が `/answer [テキスト]` で回答
- ポイントシステム
- リーダーボード

### 2. ストーリー構築
- 協力型ストーリー作成
- 視聴者が次のプロット展開を提案
- AIが提案を織り交ぜる

### 3. 投票・アンケート
- AIが選択肢を提示
- 視聴者が `/vote [選択肢]` で投票
- リアルタイム結果表示

### 4. ミニゲーム
- シンプルなテキストベースゲーム
  - じゃんけん
  - 数当てゲーム
  - しりとり

---

## コメント接頭辞システム

### 接頭辞一覧

- **`IR****`**: アイリス宛メッセージ
- **`FI****`**: フィオナ宛メッセージ
- **`#xx`**: 企画提案（例: `#quiz`、`#story`）
- **`/xx`**: 企画参加コマンド（例: `/answer`、`/vote`）

### 正規化ルール

- **大文字小文字**: 区別しない（`IR` = `ir` = `Ir`）
- **全角半角**: 対応（`ＩＲ` = `IR`）
- **表記揺れ**: 許容

### 動作モード別の反応

#### 単体モードA
- `IR****` のみ反応（アイリスが応答）

#### 単体モードB
- `FI****` のみ反応（フィオナが応答）

#### 掛け合いモード
- `IR****`: アイリスから開始
- `FI****`: フィオナから開始
- `#xx`: 基本はアイリスから（調整可）

---

## 話しかけ判定ルール

### YouTube コメント

1. **接頭辞判定**: `IR` (キャラA), `FI` (キャラB)
2. **正規化**: 大文字/小文字/全角/半角の表記揺れを許容
3. **モード別動作**:
   - **単体モード**: 起動しているキャラが応答
   - **掛け合いモード**: 指定されたキャラから開始

### 配信者（ルピナス）入力

- **キャラA用チャット**: チャットまたは音声入力 → キャラA宛
- **キャラB用チャット**: チャットまたは音声入力 → キャラB宛

---

## 掛け合い生成ロジック

### Gemini への指示

1. **プロンプト**: 「AとBの掛け合い、最大Nターン、総文字数500以内」で生成指示
2. **出力形式**: `<A>...</A><B>...</B>` の XML 形式
3. **パース**: XML を解析して順次送信

### 文字数制約

- **単体モード**: 1キャラのみ、総文字数 ≤ 250文字
- **掛け合いモード**: A+Bの総文字数 ≤ 500文字、ターン数制限なし

---

## Search Grounding（検索機能）

### 使用方針

- **毎回ではなく、必要に応じて使用**
- **使用タイミング**:
  - 最新情報が必要な場合
  - 固有名詞（ゲーム、アニメ、流行など）の解説時
  - 知識が不足している場合
- **使用しないタイミング**:
  - 漫才のネタ中
  - クイズ中
  - 恋バナ中
  - 自然な会話の流れを保つべき場面

### 実装仕様

- **API パラメータ**: `useSearchGrounding` を動的に制御
- **フォールバック**: 検索機能が失敗した場合、自動的に検索なしで再試行
- **エラー処理**: エラー時も会話を継続

---

## 音声合成（TTS）

### 対応エンジン

#### AivisSpeech（デフォルト）
- サーバー URL: `NEXT_PUBLIC_AIVIS_SPEECH_SERVER_URL`（デフォルト: `http://127.0.0.1:10101`）
- 設定可能パラメータ:
  - 話者選択（アイリス用・フィオナ用で個別設定可能）
  - 速度（Speed）
  - 音程（Pitch）
  - 抑揚（Intonation Scale）
  - テンポ・ダイナミクス（Tempo Dynamics）
  - 前音素長（Pre Phoneme Length）
  - 後音素長（Post Phoneme Length）

#### VoiceVox
- サーバー URL: `NEXT_PUBLIC_VOICEVOX_SERVER_URL`（デフォルト: `http://127.0.0.1:50021`）
- 設定可能パラメータ:
  - 話者選択（アイリス用・フィオナ用で個別設定可能）
  - 速度（Speed）
  - 音程（Pitch）
  - 抑揚（Intonation）

### 音声合成の動作（掛け合いモード）

- **独立した読み上げ**: アイリスとフィオナは別々に読み上げ
- **文単位での分割**: 各キャラクターのセリフを文単位で分割
- **感情タグに基づく音声調整**: 各キャラクターの感情タグを個別に反映
- **キュー管理**: 各キャラクターの音声キューを独立して管理
- **英語→日本語読み変換**: オプション機能

---

## Live2D アニメーション

### 掛け合いモードでの動作

- **独立したアニメーション**: アイリスとフィオナは別々にリップシンク・アニメーション
- **感情タグの反映**: 各キャラクターの感情タグ（`neutral`, `happy`, `angry`, `sad`, `relaxed`, `surprised`）に基づいて独立して動作
- **リップシンク**: 各キャラクターの音声に同期してリップシンク
- **モーション**: 感情に基づく表情・モーション変更を個別に実行

---

## YouTube 連携機能

### 基本機能
- YouTube Live コメントの取得
- コメントへの自動応答
- 会話継続モード（コメントがないときの自動発言）

### 設定項目
- YouTube API キー（必須）
- YouTube Live ID（必須）
- 会話継続モード（ON/OFF）

### 動作仕様
- `#` で始まるコメントは読み上げない（企画提案として処理）
- コメント取得間隔は自動調整
- スリープモード対応

---

## 環境変数

### 必須環境変数
```env
GOOGLE_API_KEY=              # Google Gemini API キー（必須）
```

### オプション環境変数
```env
YOUTUBE_API_KEY=             # YouTube API キー（YouTube 機能使用時）
NEXT_PUBLIC_AIVIS_SPEECH_SERVER_URL=http://127.0.0.1:10101
NEXT_PUBLIC_VOICEVOX_SERVER_URL=http://127.0.0.1:50021
NEXT_PUBLIC_SYSTEM_PROMPT=   # システムプロンプト（オプション）
```

---

## API エンドポイント

### AI 関連
- `POST /api/ai/vercel` - Gemini チャット API（Search Grounding 対応）
- `POST /api/ai/custom` - カスタム AI API

### 音声合成
- `POST /api/tts-aivisspeech` - AivisSpeech TTS
- `POST /api/tts-voicevox` - VoiceVox TTS

### YouTube
- `GET /api/external/chat` - YouTube コメント取得

### スライド
- `POST /api/convertSlide` - PDF スライド変換

### その他
- `GET /api/get-vrm-list` - VRM ファイル一覧
- `GET /api/get-live2d-list` - Live2D ファイル一覧
- `GET /api/get-background-list` - 背景画像一覧
- `POST /api/upload-vrm-list` - VRM アップロード
- `POST /api/upload-background` - 背景画像アップロード
- `POST /api/save-chat-log` - チャットログ保存

---

## 起動方法

### 開発モード

#### 単体モードA
```batch
start_A_dev.bat
```
- ポート: 3000
- キャラクター: アイリスのみ

#### 単体モードB
```batch
start_B_dev.bat
```
- ポート: 3001
- キャラクター: フィオナのみ

#### 掛け合いモード
```batch
start_dev.bat
```
- ポート: 3000
- キャラクター: アイリス + フィオナ（1タブ内に2体表示）

### 本番ビルド
```bash
npm run build
npm start
```

---

## 設定画面

### タブ構成
1. **説明** (Description)
2. **基本設定** (Based Settings)
3. **キャラクター設定** (Character Settings)
   - アイリス用設定
   - フィオナ用設定
4. **AI 設定** (AI Settings)
   - Gemini-2.0-flash 固定の旨を表示
   - 外部連携モードと検索グラウンディング（必要に応じて）の説明
5. **音声設定** (Voice Settings)
   - AivisSpeech / VoiceVox の切り替え
   - **アイリス用音声設定**（個別）
   - **フィオナ用音声設定**（個別）
6. **音声入力設定** (Speech Input Settings)
7. **YouTube 設定** (YouTube Settings)
8. **スライド設定** (Slide Settings)
9. **画像設定** (Image Settings)
10. **ログ設定** (Log Settings)
11. **その他設定** (Other Settings)

---

## 削除された機能

以下の機能は削除され、現在は使用できません：

### AI プロバイダー
- OpenAI
- Anthropic (Claude)
- Azure OpenAI
- XAI (Grok)
- Groq
- Cohere
- Mistral AI
- Perplexity
- Fireworks
- Deepseek
- OpenRouter
- LM Studio
- Ollama

### 音声合成エンジン
- Koeiromap
- Google Text-to-Speech
- StyleBertVITS2
- Aivis Cloud API
- GSVI TTS
- ElevenLabs
- Cartesia
- OpenAI TTS
- Azure OpenAI TTS
- Nijivoice

### その他の機能
- **Python バックエンド**（完全削除）
- リアルタイム API モード
- オーディオモード
- マルチモーダル切り替え（常時有効）
- カスタムモデル指定

---

## セキュリティ設定

### Next.js 設定
- `poweredByHeader: false` - X-Powered-By ヘッダーを非表示

### 環境変数保護
- `.env` ファイルは `.gitignore` に含まれており、Git にコミットされない

---

## データ保存

### ブラウザストレージ
- 設定情報: Zustand の `persist` ミドルウェアで LocalStorage に保存
- 会話履歴: 設定に基づいて保存
- **アイリス用設定**: 個別に保存
- **フィオナ用設定**: 個別に保存

### ファイル保存
- VRM ファイル: `public/vrm/`
- Live2D ファイル: `public/live2d/`
- 背景画像: `public/backgrounds/`
- スライド: `public/slides/`

---

## 依存パッケージ（主要）

### コア
- `next`: ^14.2.5
- `react`: ^18.3.1
- `react-dom`: ^18.3.1
- `typescript`: 5.0.2
- `zustand`: ^4.5.4

### AI・音声
- `ai`: 4.1 (Vercel AI SDK)
- `@ai-sdk/google`: ^1.0.3
- `@google/generative-ai`: ^0.11.3

### 3D・グラフィックス
- `three`: ^0.167.1
- `@pixiv/three-vrm`: ^3.0.0
- `pixi.js`: ^7.4.2

### その他
- `axios`: ^1.6.8
- `i18next`: ^23.6.0
- `react-i18next`: ^13.3.1
- `pdfjs-dist`: ^4.5.136

---

## バージョン情報

- **プロジェクト名**: aituber-kit
- **バージョン**: 0.1.0
- **ベース**: ChatVRM from Pixiv / ver. 2.38.0

---

## 実装済み機能

- ✅ Python バックエンドの削除
- ✅ Gemini 2.0-flash 固定
- ✅ AivisSpeech / VoiceVox のみ対応
- ✅ Search Grounding（必要に応じて）
- ✅ 外部連携モード
- ✅ YouTube コメント連携
- ✅ Live2D / VRM 対応
- ✅ 音声認識（ブラウザ API）

---

## 実装予定機能

- ⏳ **1タブ2体表示**（アイリス + フィオナ）
- ⏳ **統合セリフ枠・会話ログ**
- ⏳ **独立した音声合成**（各キャラクター別々）
- ⏳ **独立した Live2D アニメーション**（各キャラクター別々）
- ⏳ **Gemini XML 出力形式のパース**
- ⏳ **企画システム（状態マシン）**
- ⏳ **コメント接頭辞システムの実装**
- ⏳ **掛け合い生成ロジック**

---

## 注意事項

1. **API キーの管理**: `.env` ファイルは絶対に Git にコミットしないこと
2. **Search Grounding**: 検索機能は必要に応じて使用。エラー時は自動的にフォールバック
3. **TTS サーバー**: AivisSpeech または VoiceVox サーバーを事前に起動しておく必要がある
4. **Python 不要**: Python バックエンドは完全に削除されており、不要
5. **1タブ2体表示**: 掛け合いモードでは、1つのブラウザタブ内にアイリスとフィオナの2体を同時表示
6. **独立動作**: 各キャラクターは音声合成・Live2D アニメーションを独立して実行

---

最終更新: 2024年（リファクタリング後・仕様統合版）
