# 記憶システム（Long-term Memory）ガイド

## 記憶の保存場所

記憶は**ブラウザのlocalStorage**に保存されます。

- **保存キー**: `luna-ai-memories`
- **保存形式**: JSON形式
- **保存場所**: ブラウザのlocalStorage（開発者ツール → Application → Local Storage → `http://localhost:3000` → `luna-ai-memories`）

### 確認方法

1. ブラウザの開発者ツールを開く（`F12`）
2. `Application`タブを選択
3. 左側の`Local Storage` → `http://localhost:3000`を選択
4. `luna-ai-memories`キーを確認

### 記憶データの構造

```json
{
  "memories": [
    {
      "id": "msg_xxxxx",
      "type": "user_name",
      "content": "ユーザーの名前はルピナスです",
      "keywords": ["ルピナス", "名前", "ユーザー"],
      "timestamp": "2025-11-28T00:00:00.000Z",
      "relevanceScore": 5
    }
  ]
}
```

## 記憶の種類

現在、以下の種類の記憶を抽出・保存します：

1. **user_name** (ユーザー名)
   - 例: 「私の名前はルピナスです」
   - キーワード: 名前、ユーザー名

2. **user_preference** (好み)
   - 例: 「ゲームが好きです」
   - キーワード: 好み、好きなもの

将来的には、以下の種類も追加予定：
- **event** (出来事)
- **proper_noun** (固有名詞)
- **conversation_context** (会話の文脈)
- **relationship** (人間関係)

## 記憶が会話に活かされる仕組み

### 1. 記憶の抽出

会話が完了した後（約2秒後）、以下のパターンから記憶を抽出します：

- **ユーザー名の抽出**:
  - 「私は○○です」
  - 「名前は○○です」
  - 「○○と申します」

- **好みの抽出**:
  - 「○○が好きです」
  - 「○○を好みます」

### 2. 記憶の検索

新しいメッセージが送信された際、以下の手順で関連記憶を検索します：

1. **キーワードマッチング**: メッセージ内のキーワードと記憶のキーワードを照合
2. **関連度スコアの計算**: マッチしたキーワードの数や一致度に基づいてスコアを計算
3. **上位5件を取得**: スコアが高い順に最大5件の記憶を取得

### 3. システムプロンプトへの注入

検索された記憶は、システムプロンプトに以下の形式で追加されます：

```
[関連記憶]
以下の情報は、過去の会話から抽出された重要な記憶です。これらの情報を参考にして、より自然で個人的な会話をしてください。

1. [ユーザー名] ユーザーの名前はルピナスです
2. [好み] ユーザーの好み: ゲーム

[記憶の使い方]
- これらの記憶は、会話をより自然で個人的なものにするために使用してください
- 記憶に基づいて、ユーザーとの関係性を深めるような会話をしてください
- ただし、記憶が古い場合や、現在の会話と矛盾する場合は、現在の会話を優先してください
```

### 4. AIによる活用

AIは、注入された記憶を参考にして：
- ユーザーの名前を覚えている
- ユーザーの好みを考慮した会話をする
- 過去の会話内容を踏まえた自然な会話をする

## 記憶の管理

### 記憶の削除

現在、記憶を削除する機能は実装されていませんが、以下の方法で削除できます：

1. **ブラウザの開発者ツールから削除**:
   - `Application` → `Local Storage` → `luna-ai-memories`を削除

2. **プログラムから削除**（将来的に実装予定）:
   ```typescript
   import { deleteMemory, clearMemories } from '@/features/memory/memoryManager'
   
   // 特定の記憶を削除
   deleteMemory('memory_id')
   
   // 全ての記憶を削除
   clearMemories()
   ```

## 今後の改善予定

1. **AIによる自動抽出**: 現在はパターンマッチングで抽出していますが、将来的にはAIを使用してより高度な抽出を行う予定
2. **記憶の有効期限**: 古い記憶を自動的に削除する機能
3. **記憶の優先度**: 重要な記憶とそうでない記憶を区別
4. **記憶の編集**: ユーザーが記憶を編集できる機能
5. **記憶のエクスポート/インポート**: 記憶をファイルに保存・読み込みできる機能

## デバッグログ

記憶システムの動作を確認するには、以下のログを確認してください：

- `[memoryExtractor] 📝 会話から記憶を抽出:` - 記憶が抽出されたか
- `[memoryManager] ✅ 記憶を保存しました:` - 記憶が保存されたか
- `[handlers] 🔍 関連記憶を検索開始:` - 関連記憶の検索が開始されたか
- `[memoryManager] 🔍 関連記憶を検索:` - 関連記憶が見つかったか
- `[handlers] ✅ 関連記憶をシステムプロンプトに注入:` - システムプロンプトに記憶が注入されたか



